# Orval + React Query Integration

This project uses [Orval](https://orval.dev/) to generate TypeScript React Query hooks from the OpenAPI specification.

## Overview

- **Orval**: Generates type-safe API clients from OpenAPI specs
- **React Query**: Handles caching, background updates, and stale data
- **Axios**: HTTP client with interceptors for auth, error handling

## Project Structure

```
web/
├── orval.config.ts              # Orval configuration
├── src/
│   ├── components/
│   │   └── QueryProvider.tsx    # React Query provider
│   ├── lib/
│   │   ├── axios-instance.ts    # Custom axios instance
│   │   └── query-client.ts      # React Query client config
│   ├── generated/               # Generated by Orval (don't edit)
│   │   ├── api/                 # API hooks per tag
│   │   │   ├── auth/
│   │   │   └── x-account/
│   │   └── model/               # TypeScript types
│   └── routes/
│       └── demo/orval-example.tsx  # Example usage
```

## Setup

### 1. Install dependencies (already done)

```bash
pnpm add @tanstack/react-query @tanstack/react-query-devtools axios
pnpm add -D orval
```

### 2. Generate API client

**Prerequisites**: Make sure the API server is running at `http://localhost:3000`

```bash
# Start the API server first
cd ../api && pnpm dev

# Then generate the client
cd web
pnpm generate:api
```

**Watch mode (auto-regenerate on API changes)**
```bash
pnpm generate:api:watch
```

## Usage

### Basic Query (GET request)

```tsx
import { useGetXAccount } from '@/generated/api'

function MyComponent() {
  const { data, isLoading, error } = useGetXAccount()

  if (isLoading) return <div>Loading...</div>
  if (error) return <div>Error: {error.message}</div>

  return <div>Account ID: {data?.data.id}</div>
}
```

### Mutation (POST/PUT/DELETE)

```tsx
import { useSaveXAccount, useDeleteXAccount } from '@/generated/api'

function MyComponent() {
  // Save mutation
  const saveMutation = useSaveXAccount({
    mutation: {
      onSuccess: (data) => {
        console.log('Saved!', data)
      },
      onError: (error) => {
        console.error('Failed:', error)
      },
    },
  })

  // Delete mutation
  const deleteMutation = useDeleteXAccount()

  const handleSave = () => {
    saveMutation.mutate({ 
      data: { authToken: 'xxx', ct0: 'yyy' } 
    })
  }

  const handleDelete = () => {
    deleteMutation.mutate()
  }

  return (
    <div>
      <button onClick={handleSave} disabled={saveMutation.isPending}>
        {saveMutation.isPending ? 'Saving...' : 'Save'}
      </button>
      <button onClick={handleDelete} disabled={deleteMutation.isPending}>
        Delete
      </button>
    </div>
  )
}
```

### Query Options (for prefetching)

```tsx
import { getGetXAccountQueryOptions } from '@/generated/api'
import { queryClient } from '@/lib/query-client'

// Prefetch data
await queryClient.prefetchQuery(getGetXAccountQueryOptions())

// Or in a loader
export const Route = createFileRoute('/my-route')({
  loader: async () => {
    return queryClient.fetchQuery(getGetXAccountQueryOptions())
  },
})
```

### Infinite Query (pagination)

```tsx
import { useGetXAccountInfinite } from '@/generated/api'

function MyComponent() {
  const { data, fetchNextPage, hasNextPage, isFetchingNextPage } = useGetXAccountInfinite()

  return (
    <div>
      {data?.pages.map((page, i) => (
        <div key={i}>{/* render page data */}</div>
      ))}
      <button 
        onClick={() => fetchNextPage()} 
        disabled={!hasNextPage || isFetchingNextPage}
      >
        Load More
      </button>
    </div>
  )
}
```

## Configuration

### Orval Config (`orval.config.ts`)

```typescript
export default defineConfig({
  api: {
    input: {
      target: 'http://localhost:3000/documentation/json', // OpenAPI spec from API
    },
    output: {
      mode: 'tags-split',           // Split files by OpenAPI tags
      target: './src/generated/api',
      schemas: './src/generated/model',
      client: 'react-query',        // Generate React Query hooks
      override: {
        mutator: {
          path: './src/lib/axios-instance.ts',
          name: 'customInstance',   // Use custom axios instance
        },
      },
    },
  },
});
```

### Axios Instance (`src/lib/axios-instance.ts`)

The custom axios instance includes:
- Base URL configuration
- Request/response interceptors
- Error handling (e.g., 401 redirects)
- Cookie support (`withCredentials: true`)

### Query Client (`src/lib/query-client.ts`)

Default React Query configuration:
- `staleTime`: 5 minutes
- `gcTime`: 30 minutes
- `retry`: 3 times (except 401/403)
- `refetchOnWindowFocus`: false

## Best Practices

1. **Don't edit generated files**: They're in `src/generated/` and will be overwritten
2. **Use query keys for invalidation**: Orval generates query keys automatically
3. **Handle loading and error states**: Always check `isLoading` and `error`
4. **Use mutations for side effects**: POST/PUT/DELETE should use mutations
5. **Prefetch when possible**: Use `queryClient.prefetchQuery` for better UX
6. **Always start API before generating**: The spec is fetched from the running API

## Environment Variables

Create a `.env` file in the `web/` directory:

```env
VITE_API_URL=http://localhost:3000  # API base URL
```

## Troubleshooting

### Generation fails
- **Make sure the API server is running** at `http://localhost:3000`
- Check that the API exposes the OpenAPI spec at `/documentation/json`

### Type errors after generation
- Run `pnpm check` to format and lint
- Orval runs Prettier automatically after generation

### CORS errors
- Ensure the API server has CORS enabled for your frontend URL
- The API should allow credentials for cookie-based auth

## Resources

- [Orval Documentation](https://orval.dev/docs/guides/react-query)
- [React Query Documentation](https://tanstack.com/query/latest)
- [TanStack Start Documentation](https://tanstack.com/start/latest)
